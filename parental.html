<script>
const SUPABASE_URL = 'https://yqzlwsmpkqeocyhduizf.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

const form = document.getElementById('consentForm');
const sendBtn = document.getElementById('sendBtn');
const btnText = document.getElementById('btnText');
const statusDiv = document.getElementById('status');
const parentNameField = document.getElementById('parentName');
const parentEmailField = document.getElementById('parentEmail');

function setLoading(loading) {
  if (loading) {
    btnText.innerHTML = '<span class="spinner"></span> Sending...';
    sendBtn.disabled = true;
    parentNameField.disabled = true;
    parentEmailField.disabled = true;
    statusDiv.textContent = '';
    statusDiv.classList.remove('error');
  } else {
    btnText.textContent = 'Send the Magic! ðŸŒŸ';
    sendBtn.disabled = false;
    parentNameField.disabled = false;
    parentEmailField.disabled = false;
  }
}

async function postSendConsent(parentName, parentEmail) {
  const resp = await fetch(`${SUPABASE_URL}/functions/v1/send-consent-email`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${SUPABASE_ANON_KEY}` // Supabase anon key
    },
    body: JSON.stringify({ parentName, parentEmail })
  });
  return resp;
}

}


form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const parentName = parentNameField.value.trim();
  const parentEmail = parentEmailField.value.trim();

  if (!parentName || !parentEmail) {
    statusDiv.textContent = 'Please fill both fields.';
    statusDiv.classList.add('error');
    return;
  }

  try {
    setLoading(true);

    const resp = await postSendConsent(parentName, parentEmail);

    if (!resp.ok) {
      let msg;
      try { msg = (await resp.json()).error || (await resp.json()).message; } catch { msg = await resp.text(); }
      throw new Error(msg || `Server returned ${resp.status}`);
    }

    statusDiv.classList.remove('error');
    statusDiv.textContent = "Sent â€” ask your parent to check their Gmail (including Spam). âœ…";
    setTimeout(() => {
      parentNameField.value = '';
      parentEmailField.value = '';
      setLoading(false);
    }, 900);

  } catch (err) {
    statusDiv.classList.add('error');
    statusDiv.textContent = `Oops â€” couldn't send request. ${err.message}`;
    setLoading(false);
  }
});
</script>


